<div class="container-reservations mat-elevation-z8">
  <div class="loading-shade" *ngIf="isLoadingResults">
    <mat-spinner *ngIf="isLoadingResults"></mat-spinner>
  </div>
  <div class="d-flex align-items-center pb-2 pt-3">
    <div class="form-field filter-field">
      <label class="form-label" for="filterInput"
        >Filter reservations
        <i
          class="bi bi-info-square-fill"
          #tooltip="matTooltip"
          matTooltip="Acceptable values: &nbsp; &nbsp; 'John', 'John Doe', 'Doe', 'Doe John'"
          matTooltipPosition="above"
          matTooltipHideDelay="5000"
        ></i
      ></label>
      <input
        type="text"
        class="form-control"
        placeholder="Filter by name "
        id="filterInput"
        [formControl]="nameFilter"
      />
    </div>

    <div class="form-field">
      <label class="form-label" for="statusSelect">Status</label>
      <div class="input-group">
        <label class="input-group-text" for="statusSelect"
          ><i class="bi bi-funnel-fill text-primary"></i
        ></label>
        <select
          class="form-select"
          id="statusSelect"
          aria-label="Filter status select"
          placeholder="Filter by status"
          [(ngModel)]="statusFilter"
          (ngModelChange)="applyFilter('status')"
        >
          <option value="">All statuses</option>
          <option value="COMPLETED">Completed</option>
          <option value="CONFIRMED">Confirmed</option>
          <option value="PENDING">Pending</option>
          <option value="CANCELLED">Cancelled</option>
        </select>
      </div>
    </div>
    <div class="form-field">
      <label class="form-label" for="todaysCheckbox">Today's</label>
      <div class="form-check form-switch d-flex align-items-center">
        <input
          class="form-check-input"
          type="checkbox"
          role="switch"
          id="todaysCheckbox"
          (click)="applyFilter('todays')"
        />
      </div>
    </div>
  </div>
  <div class="container-table">
    <table mat-table [dataSource]="data" multiTemplateDataRows matSort>
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let element">
          {{ element.id }}
        </td>
      </ng-container>
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
        <td mat-cell *matCellDef="let element">
          <span class="text-capitalize"
            >{{ element.personalData.firstName }}
            {{ element.personalData.secondName }}</span
          >
        </td>
      </ng-container>
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
        <td mat-cell *matCellDef="let element">
          {{ formatDate(element.date, element.hour) }}
        </td>
      </ng-container>
      <ng-container matColumnDef="people">
        <th mat-header-cell *matHeaderCellDef>People</th>
        <td mat-cell *matCellDef="let element">
          {{ element.peopleNumber }}
        </td>
      </ng-container>
      <ng-container matColumnDef="table">
        <th mat-header-cell *matHeaderCellDef>Table</th>
        <td mat-cell *matCellDef="let element">
          {{ element.tableNumber }}
        </td>
      </ng-container>
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let element">
          <span
            class="badge d-flex align-items-center justify-content-center"
            [ngClass]="setBadgeClass(element.status)"
          >
            {{ element.status }}</span
          >
        </td>
      </ng-container>
      <ng-container matColumnDef="complete">
        <th mat-header-cell *matHeaderCellDef aria-label="row actions">
          &nbsp;
        </th>
        <td mat-cell *matCellDef="let element">
          <button
            class="btn btn-success"
            [disabled]="!element.canComplete"
            (click)="setAction('complete', element.id)"
            data-bs-toggle="modal"
            data-bs-target="#confirmActionModal"
          >
            Complete
          </button>
        </td>
      </ng-container>
      <ng-container matColumnDef="cancel">
        <th mat-header-cell *matHeaderCellDef aria-label="row actions">
          &nbsp;
        </th>
        <td mat-cell *matCellDef="let element">
          <button
            class="btn btn-danger"
            [disabled]="!element.isCancellable"
            (click)="setCancelledReservation(element)"
            data-bs-toggle="modal"
            data-bs-target="#cancelModal"
          >
            Cancel
          </button>
        </td>
      </ng-container>
      <ng-container matColumnDef="expand">
        <th mat-header-cell *matHeaderCellDef aria-label="row actions">
          &nbsp;
        </th>
        <td mat-cell *matCellDef="let element">
          <button
            mat-icon-button
            aria-label="expand row"
            (click)="
              expandedElement = expandedElement === element ? null : element;
              $event.stopPropagation()
            "
          >
            <mat-icon *ngIf="expandedElement !== element"
              >keyboard_arrow_down</mat-icon
            >
            <mat-icon *ngIf="expandedElement === element"
              >keyboard_arrow_up</mat-icon
            >
          </button>
        </td>
      </ng-container>

      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="columnsToDisplay.length"
        >
          <div
            class="element-detail"
            [@detailExpand]="
              element == expandedElement ? 'expanded' : 'collapsed'
            "
          >
            <div>
              <h6 class="mb-0">Contact:</h6>
              <p class="mb-0">{{ element.personalData.email }}</p>
              <p>{{ element.personalData.phone }}</p>
            </div>
            <div *ngIf="element.cancellationReason">
              <h6 class="mb-0">Cancellation reason:</h6>
              <p>{{ element.cancellationReason }}</p>
            </div>
            <div
              class="d-flex flex-column"
              *ngIf="optionsToArray(element.additionalOptions).length > 0"
            >
              <h6 class="mb-0">Additional options:</h6>
              <div
                class="option"
                *ngFor="let option of optionsToArray(element.additionalOptions)"
              >
                <i class="bi bi-check-square-fill"></i>
                <span class="text-capitalize"> {{ option }}</span>
              </div>
            </div>
            <div *ngIf="element.requests">
              <h6 class="mb-0">Special requests:</h6>
              <p>{{ element.requests }}</p>
            </div>
            <div *ngIf="element.completedBy">
              <h6 class="mb-0">Completed by:</h6>
              <p>{{ element.completedBy }}</p>
            </div>
            <div *ngIf="element.cancelledBy">
              <h6 class="mb-0">Cancelled by:</h6>
              <p>{{ element.cancelledBy }}</p>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="columnsToDisplay; sticky: true"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: columnsToDisplay"
        class="element-row"
        [class.expanded-row]="expandedElement === element"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="detail-row"
      ></tr>

      <tr class="mat-row" *matNoDataRow>
        <td
          *ngIf="!isLoadingResults"
          class="mat-cell p-2 text-primary"
          colspan="4"
        >
          <h6>Couldn't find any reservations</h6>
        </td>
      </tr>
    </table>
  </div>
  <mat-paginator
    [length]="resultsLength"
    [pageSize]="10"
    [pageSizeOptions]="[5, 10]"
  ></mat-paginator>
</div>

<div
  class="modal fade"
  id="cancelModal"
  tabindex="-1"
  aria-labelledby="cancelModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h1 class="modal-title fs-5 text-white" id="cancelModalLabel">
          Cancel reservation
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="resetValues()"
        ></button>
      </div>
      <div class="modal-body">
        <ng-container *ngIf="cancelledReservation">
          <h6>
            Reservation: <span>{{ cancelledReservation.id }}</span>
          </h6>
          <h6>
            Name:
            <span class="text-capitalize"
              >{{ cancelledReservation.personalData.firstName }}
              {{ cancelledReservation.personalData.secondName }}</span
            >
          </h6>
          <h6>
            Date:
            <span>
              {{
                formatDate(
                  cancelledReservation.date.toString(),
                  cancelledReservation.hour
                )
              }}</span
            >
          </h6>
          <h6>
            Contact:
            <span>
              {{ cancelledReservation.personalData.email }},
              {{ cancelledReservation.personalData.phone }}</span
            >
          </h6>

          <form
            [formGroup]="cancelForm"
            class="d-flex flex-wrap"
            id="reservationForm"
          >
            <div class="form-field p-0">
              <label class="form-label" for="reasonSelect"
                >To cancel reservation please select cancellation reason</label
              >
              <div class="input-group reason-select">
                <select
                  class="form-select"
                  id="reasonSelect"
                  aria-label="Cancellation reason"
                  placeholder="Cancellation reason"
                  formControlName="reason"
                >
                  <option value="">Select reason</option>
                  <option value="The customer did not appear.">
                    The customer did not appear
                  </option>
                  <option value="Cancelled on customer's request.">
                    Cancelled on customer's request
                  </option>
                  <option value="Unexpected circumstances.">
                    Unexpected circumstances
                  </option>
                  <option value="Technical issues.">Technical issues</option>
                  <option value="Kitchen breakdown.">Kitchen breakdown</option>
                </select>
              </div>
            </div>

            <button
              type="submit"
              form="cancelForm"
              class="btn btn-danger mt-2"
              data-bs-dismiss="modal"
              data-bs-toggle="modal"
              data-bs-target="#confirmActionModal"
              [disabled]="cancelForm.controls.reason.value === ''"
            >
              Cancel
            </button>
          </form>
        </ng-container>
      </div>
      <div class="modal-footer"></div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="confirmActionModal"
  tabindex="-1"
  aria-labelledby="confrimActionModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h1 class="modal-title fs-5 text-white" id="confrimActionModalLabel">
          <span class="text-capitalize">{{ action }}</span> reservation
        </h1>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          data-bs-toggle="modal"
          data-bs-target="#cancelModal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <figure>
          <blockquote class="blockquote">
            <h6>
              Are you sure you want {{ action }}
              reservation?
            </h6>
          </blockquote>
          <figcaption class="blockquote-footer">
            You can't undo this action.
          </figcaption>
        </figure>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-primary"
          data-bs-dismiss="modal"
          data-bs-toggle="modal"
          data-bs-target="#cancelModal"
        >
          No, Close
        </button>
        <button
          type="button"
          class="btn btn-primary"
          data-bs-dismiss="modal"
          (click)="updateReservation()"
        >
          Yes, {{ action }}
        </button>
      </div>
    </div>
  </div>
</div>
